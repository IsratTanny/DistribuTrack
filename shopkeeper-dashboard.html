<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"/>
  <title>DistribuTrack - Shopkeeper Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: {
            primary: {
              50: '#eff6ff', 100:'#dbeafe', 200:'#bfdbfe', 300:'#93c5fd', 400:'#60a5fa',
              500:'#3b82f6', 600:'#2563eb', 700:'#1d4ed8', 800:'#1e40af', 900:'#1e3a8a'
            },
            secondary: { 500:'#f59e0b' }
          }
        }
      }
    }
  </script>

  <style>
    .card-hover { transition: transform .2s ease, box-shadow .2s ease; }
    .card-hover:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -10px rgba(0,0,0,.25); }
    .notification-badge { position:absolute; top:-8px; right:-8px; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">

  <!-- Navbar -->
  <nav class="bg-gradient-to-r from-primary-700 to-primary-800 text-white p-4 flex justify-between items-center shadow-lg">
    <div class="flex items-center space-x-3">
      <img src="./DistribuTrack.png" alt="logo" class="h-9 rounded-md shadow-md">
      <span class="text-xl font-bold tracking-tight">DistribuTrack</span>
    </div>
    <div class="flex items-center space-x-4">
      <div class="relative">
        <button id="notifBtn" class="p-2 rounded-full hover:bg-primary-700 transition" aria-label="Notifications">
          <i class="fas fa-bell text-lg"></i>
          <span id="notifBadge" class="notification-badge hidden bg-secondary-500 text-white text-xs font-bold rounded-full h-5 w-5 leading-5 text-center">0</span>
        </button>
      </div>
      <div class="h-8 w-px bg-white/30"></div>
      <a href="shopkeeper.html" class="flex items-center space-x-2 bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition">
        <i class="fas fa-sign-out-alt"></i><span>Logout</span>
      </a>
    </div>
  </nav>

  <!-- Container -->
  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- Welcome -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
      <div>
        <h1 class="text-3xl font-bold text-gray-800">Welcome back, <span id="shopName" class="text-primary-600">Shopkeeper</span>!</h1>
        <p class="text-gray-500 mt-1">Here’s what’s happening with your store</p>
      </div>
      <div class="mt-4 md:mt-0">
        <span id="lastLogin" class="text-sm text-gray-500">Today</span>
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-primary-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-500">Active Orders</p>
            <p id="kpiActive" class="text-2xl font-bold text-gray-800 mt-1">—</p>
          </div>
          <div class="bg-primary-100 p-3 rounded-lg">
            <i class="fas fa-truck text-primary-600 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-green-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-500">Completed Today</p>
            <p id="kpiCompletedToday" class="text-2xl font-bold text-gray-800 mt-1">—</p>
          </div>
          <div class="bg-green-100 p-3 rounded-lg">
            <i class="fas fa-check-circle text-green-600 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-yellow-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-500">Pending</p>
            <p id="kpiPending" class="text-2xl font-bold text-gray-800 mt-1">—</p>
          </div>
          <div class="bg-yellow-100 p-3 rounded-lg">
            <i class="fas fa-clock text-yellow-600 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-purple-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-500">New Alerts</p>
            <p id="kpiAlerts" class="text-2xl font-bold text-gray-800 mt-1">—</p>
          </div>
          <div class="bg-purple-100 p-3 rounded-lg">
            <i class="fas fa-envelope text-purple-600 text-xl"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Main grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Active Orders -->
      <div class="bg-white rounded-xl shadow-sm overflow-hidden card-hover">
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-gray-800">Active Orders</h3>
            <div id="activeBadge" class="bg-primary-100 text-primary-800 text-xs font-bold px-2 py-1 rounded-full">—</div>
          </div>
          <p class="text-gray-500 mb-4">Track and manage your current orders in progress.</p>
          <div id="activeOrders" class="space-y-3 mb-6"></div>
          <a href="sales-reports.html" class="w-full block text-center bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg transition">
            View Orders <i class="fas fa-arrow-right ml-2"></i>
          </a>
        </div>
      </div>

      <!-- Notifications -->
      <div class="bg-white rounded-xl shadow-sm overflow-hidden card-hover">
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-gray-800">Notifications</h3>
            <div id="notifCount" class="bg-red-100 text-red-800 text-xs font-bold px-2 py-1 rounded-full">—</div>
          </div>
          <p class="text-gray-500 mb-4">Recent updates and important alerts.</p>
          <div id="notifList" class="space-y-3 mb-6"></div>
          <a href="sales-reports.html" class="w-full block text-center bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-lg transition">
            View Reports <i class="fas fa-arrow-right ml-2"></i>
          </a>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="bg-white rounded-xl shadow-sm overflow-hidden card-hover">
        <div class="p-6">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">Quick Actions</h3>
          <p class="text-gray-500 mb-6">Manage your store efficiently with these shortcuts.</p>
          <div class="grid grid-cols-2 gap-3 mb-6">
            <a href="browse-products.php" class="p-4 bg-indigo-50 hover:bg-indigo-100 rounded-lg text-center transition">
              <div class="bg-indigo-100 p-3 rounded-lg inline-block mb-2">
                <i class="fas fa-boxes text-indigo-600 text-xl"></i>
              </div>
              <p class="text-sm font-medium">Browse Products</p>
            </a>
            <a href="cart.php" class="p-4 bg-green-50 hover:bg-green-100 rounded-lg text-center transition">
              <div class="bg-green-100 p-3 rounded-lg inline-block mb-2">
                <i class="fas fa-shopping-cart text-green-600 text-xl"></i>
              </div>
              <p class="text-sm font-medium">View Cart</p>
            </a>
            <a href="sales-reports.html" class="p-4 bg-blue-50 hover:bg-blue-100 rounded-lg text-center transition">
              <div class="bg-blue-100 p-3 rounded-lg inline-block mb-2">
                <i class="fas fa-chart-line text-blue-600 text-xl"></i>
              </div>
              <p class="text-sm font-medium">Reports</p>
            </a>
            <a href="login.html" class="p-4 bg-purple-50 hover:bg-purple-100 rounded-lg text-center transition">
              <div class="bg-purple-100 p-3 rounded-lg inline-block mb-2">
                <i class="fas fa-right-to-bracket text-purple-600 text-xl"></i>
              </div>
              <p class="text-sm font-medium">Switch Role</p>
            </a>
          </div>
          <a href="#" class="w-full block text-center border border-gray-200 hover:border-gray-300 text-gray-700 px-4 py-2 rounded-lg transition">
            <i class="fas fa-cog mr-2"></i> Settings
          </a>
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="mt-8 bg-white rounded-xl shadow-sm overflow-hidden">
      <div class="p-6 border-b border-gray-100">
        <h3 class="text-xl font-semibold text-gray-800">Recent Activity</h3>
      </div>
      <div id="activityList" class="divide-y divide-gray-100"></div>
      <div class="p-4 border-t border-gray-100 text-center">
        <a href="sales-reports.html" class="text-primary-600 hover:text-primary-800 text-sm font-medium">View full history</a>
      </div>
    </div>

    <!-- Alerts -->
    <div id="alert" class="hidden mt-6 p-4 rounded border text-sm"></div>
  </div>

  <!-- Footer -->
  <footer class="bg-white border-t border-gray-200 mt-12">
    <div class="container mx-auto px-4 py-6">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div class="flex items-center space-x-2 mb-4 md:mb-0">
          <img src="./DistribuTrack.png" alt="logo" class="h-8">
          <span class="text-lg font-semibold text-gray-700">DistribuTrack</span>
        </div>
        <div class="flex space-x-6">
          <a href="#" class="text-gray-500 hover:text-primary-600 transition">Privacy</a>
          <a href="#" class="text-gray-500 hover:text-primary-600 transition">Terms</a>
          <a href="#" class="text-gray-500 hover:text-primary-600 transition">Help Center</a>
          <a href="#" class="text-gray-500 hover:text-primary-600 transition">Contact</a>
        </div>
      </div>
      <div class="mt-4 text-center md:text-left text-sm text-gray-500">
        &copy; <span id="year"></span> DistribuTrack. All rights reserved.
      </div>
    </div>
  </footer>

  <script>
    const alertBox = document.getElementById('alert');
    const shopNameEl = document.getElementById('shopName');
    const lastLoginEl = document.getElementById('lastLogin');
    const yearEl = document.getElementById('year');
    const notifBadge = document.getElementById('notifBadge');
    const notifCountPill = document.getElementById('notifCount');
    const notifList = document.getElementById('notifList');
    const activeOrdersEl = document.getElementById('activeOrders');
    const activeBadge = document.getElementById('activeBadge');
    const activityList = document.getElementById('activityList');

    const kpiActive = document.getElementById('kpiActive');
    const kpiCompletedToday = document.getElementById('kpiCompletedToday');
    const kpiPending = document.getElementById('kpiPending');
    const kpiAlerts = document.getElementById('kpiAlerts');

    yearEl.textContent = new Date().getFullYear();
    lastLoginEl.textContent = new Date().toLocaleString();

    function showAlert(type, text) {
      alertBox.textContent = text;
      alertBox.className = 'mt-6 p-4 rounded border text-sm ' + (type === 'error'
        ? 'border-red-200 bg-red-50 text-red-700'
        : 'border-amber-200 bg-amber-50 text-amber-700');
      alertBox.classList.remove('hidden');
      setTimeout(() => alertBox.classList.add('hidden'), 3000);
    }

    function statusPill(status) {
      const map = {
        'Paid': 'bg-green-100 text-green-700',
        'Pending': 'bg-yellow-100 text-yellow-700',
        'Delivered': 'bg-blue-100 text-blue-700',
        'Cancelled': 'bg-red-100 text-red-700'
      };
      return `<span class="px-2 py-0.5 rounded text-xs ${map[status] || 'bg-gray-100 text-gray-700'}">${status || '—'}</span>`;
    }

    function fmtBDT(n) {
      try {
        return new Intl.NumberFormat('bn-BD', { style: 'currency', currency: 'BDT', maximumFractionDigits: 2 }).format(Number(n||0));
      } catch {
        return '৳' + Number(n||0).toFixed(2);
      }
    }

    async function getJSON(url) {
      const res = await fetch(url, { headers: { 'Accept':'application/json' }});
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const json = await res.json();
      if (json && json.success === false) throw new Error(json.error || 'Request failed');
      return json;
    }

    async function loadNotifications() {
      try {
        const data = await getJSON('notifications.php?role=shopkeeper');
        const items = data.data || [];
        const count = items.length;

        // KPI
        kpiAlerts.textContent = count;
        notifCountPill.textContent = count || '0';
        notifBadge.textContent = count || '0';
        notifCountPill.classList.toggle('hidden', count === 0);
        notifBadge.classList.toggle('hidden', count === 0);

        // Render list (latest 4)
        notifList.innerHTML = '';
        (items.slice(0,4)).forEach(n => {
          const icon =
            n.type === 'order_status' ? 'fa-truck' :
            n.type === 'cart_reminder' ? 'fa-shopping-cart' : 'fa-bell';
          const tone =
            n.type === 'cart_reminder' ? 'yellow' :
            n.type === 'order_status' ? 'blue' : 'indigo';

          const div = document.createElement('div');
          div.className = `p-3 bg-${tone}-50 rounded-lg`;
          div.innerHTML = `
            <div class="flex items-start space-x-3">
              <div class="bg-${tone}-100 p-2 rounded-lg">
                <i class="fas ${icon} text-${tone}-600"></i>
              </div>
              <div>
                <p class="text-sm font-medium">${n.title || 'Notification'}</p>
                <p class="text-xs text-gray-500">${n.message || ''}</p>
              </div>
            </div>
          `;
          notifList.appendChild(div);
        });

      } catch(e) {
        kpiAlerts.textContent = '—';
      }
    }

    async function loadOrders() {
      try {
        // All recent orders for the shopkeeper
        const data = await getJSON('fetch_orders.php?role=shopkeeper&limit=50&scope=all');
        const orders = (data.data || data.orders || []);

        // KPIs
        const active = orders.filter(o => (o.status !== 'Delivered' && o.status !== 'Cancelled')).length;
        const pending = orders.filter(o => o.status === 'Pending').length;

        // Completed today:
        const todayStr = new Date().toISOString().slice(0,10);
        const completedToday = orders.filter(o => {
          if (!o.created_at) return false;
          const d = o.created_at.slice(0,10);
          return d === todayStr && (o.status === 'Delivered' || o.status === 'Paid');
        }).length;

        kpiActive.textContent = active;
        kpiPending.textContent = pending;
        kpiCompletedToday.textContent = completedToday;
        activeBadge.textContent = `${active} active`;

        // Name (if endpoint supplies)
        if (data.shop_name) shopNameEl.textContent = data.shop_name;

        // Active list (top 5)
        activeOrdersEl.innerHTML = '';
        const activeTop = orders
          .filter(o => (o.status !== 'Delivered' && o.status !== 'Cancelled'))
          .slice(0,5);

        if (!activeTop.length) {
          activeOrdersEl.innerHTML = `<p class="text-sm text-gray-500">No active orders at the moment.</p>`;
        } else {
          activeTop.forEach(o => {
            const row = document.createElement('div');
            row.className = 'flex items-center justify-between';
            row.innerHTML = `
              <div class="flex items-center space-x-3">
                <div class="h-2 w-2 rounded-full ${o.status === 'Pending' ? 'bg-yellow-500' : 'bg-primary-500'}"></div>
                <span class="text-sm font-medium">Order #${o.order_id || o.id}</span>
              </div>
              <div class="flex items-center gap-3 text-sm text-gray-600">
                <span>${fmtBDT(o.total_amount)}</span>
                ${statusPill(o.status)}
              </div>
            `;
            activeOrdersEl.appendChild(row);
          });
        }

        // Recent activity (latest 6, any status)
        activityList.innerHTML = '';
        (orders.slice(0,6)).forEach(o => {
          const tone =
            o.status === 'Delivered' ? 'green' :
            o.status === 'Pending' ? 'yellow' :
            o.status === 'Paid' ? 'blue' : 'gray';
          const icon =
            o.status === 'Delivered' ? 'fa-check-circle' :
            o.status === 'Pending' ? 'fa-exclamation-triangle' :
            o.status === 'Paid' ? 'fa-truck' : 'fa-receipt';

          const when = o.created_at
            ? new Date(o.created_at.replace(' ', 'T')).toLocaleString()
            : '';

          const item = document.createElement('div');
          item.className = 'p-4 hover:bg-gray-50 transition';
          item.innerHTML = `
            <div class="flex items-center space-x-4">
              <div class="bg-${tone}-100 p-3 rounded-lg">
                <i class="fas ${icon} text-${tone}-600"></i>
              </div>
              <div>
                <p class="font-medium">Order #${o.order_id || o.id} — ${o.status}</p>
                <p class="text-sm text-gray-500">${when}</p>
              </div>
            </div>
          `;
          activityList.appendChild(item);
        });

      } catch(e) {
        showAlert('error', 'Could not load your orders. Please refresh.');
        kpiActive.textContent = '—';
        kpiPending.textContent = '—';
        kpiCompletedToday.textContent = '—';
        activeOrdersEl.innerHTML = `<p class="text-sm text-gray-500">Unable to load orders.</p>`;
      }
    }

    async function init() {
      await Promise.all([loadNotifications(), loadOrders()]);
    }

    init();
  </script>
</body>
</html>
