<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DistribuTrack - Inventory Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .card-hover{ transition: transform .2s ease, box-shadow .2s ease; }
    .card-hover:hover{ transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); }
    .toast{ position: fixed; right: 1rem; bottom: 1rem; background:#111827; color:#fff; padding:.75rem 1rem; border-radius:.5rem; opacity:0; transform: translateY(10px); transition: all .25s ease; z-index:50;}
    .toast.show{ opacity:1; transform: translateY(0); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- Navbar -->
  <nav class="bg-gradient-to-r from-blue-700 to-blue-600 text-white px-6 py-4 flex justify-between items-center shadow-sm">
    <div class="flex items-center space-x-3">
      <img src="./DistribuTrack.png" alt="logo" class="h-8">
      <span class="text-xl font-semibold tracking-tight">DistribuTrack</span>
    </div>
    <a href="distributor-dashboard.html" class="bg-white text-blue-700 px-4 py-2 rounded-md hover:bg-gray-100 transition font-medium">
      Back to Dashboard
    </a>
  </nav>

  <!-- Container -->
  <div class="container mx-auto px-6 py-8 max-w-6xl">
    <div class="mb-8">
      <h1 class="text-2xl font-bold text-gray-800">Inventory Management</h1>
      <p class="text-gray-500 mt-1">Manage your product inventory and stock levels</p>
    </div>

    <!-- Add Product -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8 card-hover" id="add">
      <h2 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 mr-2" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
        </svg>
        Add New Product
      </h2>

      <div id="formAlert" class="hidden mb-4 rounded-md border px-4 py-3 text-sm"></div>

      <form id="inventory-form" class="grid grid-cols-1 md:grid-cols-2 gap-5" action="add_inventory.php" method="POST" enctype="multipart/form-data">
        <!-- Product Name -->
        <div>
          <label for="product_name" class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
          <input type="text" id="product_name" name="product_name" placeholder="Enter product name"
                 class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                 required maxlength="150">
        </div>

        <!-- Stock Quantity -->
        <div>
          <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Stock Quantity</label>
          <input type="number" id="quantity" name="quantity" min="0" placeholder="Enter quantity"
                 class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                 required>
        </div>

        <!-- Price -->
        <div>
          <label for="price" class="block text-sm font-medium text-gray-700 mb-1">Price (BDT)</label>
          <input type="number" id="price" name="price" step="0.01" min="0" placeholder="0.00"
                 class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                 required>
        </div>

        <!-- Description -->
        <div>
          <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description (optional)</label>
          <input type="text" id="description" name="description" placeholder="Short description"
                 class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>

        <!-- Product Image -->
        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-5">
          <div>
            <label for="product_image" class="block text-sm font-medium text-gray-700 mb-1">Product Image</label>
            <input type="file" id="product_image" name="product_image" accept="image/*"
                   class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                   required>
            <p class="text-xs text-gray-500 mt-1">Accepts JPG/PNG/WEBP up to 4MB.</p>
          </div>
          <div>
            <span class="block text-sm font-medium text-gray-700 mb-1">Preview</span>
            <img id="preview" src="https://via.placeholder.com/300x200?text=Preview" alt="Preview" class="h-32 w-full max-w-xs object-cover rounded-md border">
          </div>
        </div>

        <!-- Submit Button -->
        <div class="md:col-span-2">
          <button id="submitBtn" type="submit"
                  class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition font-medium flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"/>
            </svg>
            Add Product
          </button>
        </div>
      </form>
    </div>

    <!-- Inventory Table -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <h2 class="text-lg font-semibold text-gray-700 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
          </svg>
          Current Inventory
        </h2>

        <div class="flex items-center gap-2">
          <input id="search" type="text" placeholder="Search products…" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
          <label class="inline-flex items-center text-sm text-gray-600 gap-2">
            <input id="instockOnly" type="checkbox" class="rounded border-gray-300">
            In stock only
          </label>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody id="inventory-table-body" class="bg-white divide-y divide-gray-200">
            <!-- rows injected -->
          </tbody>
        </table>
      </div>

      <div class="flex items-center justify-between px-6 py-4 border-t border-gray-200">
        <div id="pagingInfo" class="text-sm text-gray-600">—</div>
        <div class="flex gap-2">
          <button id="prevBtn" class="px-3 py-1.5 rounded-md border text-sm disabled:opacity-50 disabled:cursor-not-allowed">Prev</button>
          <button id="nextBtn" class="px-3 py-1.5 rounded-md border text-sm disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    const LOW_STOCK = 5;

    const tableBody = document.getElementById('inventory-table-body');
    const search = document.getElementById('search');
    const instockOnly = document.getElementById('instockOnly');
    const pagingInfo = document.getElementById('pagingInfo');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    const form = document.getElementById('inventory-form');
    const formAlert = document.getElementById('formAlert');
    const submitBtn = document.getElementById('submitBtn');
    const imgInput = document.getElementById('product_image');
    const preview = document.getElementById('preview');
    const toast = document.getElementById('toast');

    // Paging state
    let limit = 10;
    let offset = 0;
    let lastTotal = 0;
    let lastReturned = 0;

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2200);
    }

    function fmtBDT(n){
      try{
        return new Intl.NumberFormat('bn-BD', {style:'currency', currency:'BDT', maximumFractionDigits:2}).format(Number(n||0));
      }catch{
        return '৳' + Number(n||0).toFixed(2);
      }
    }

    function setFormAlert(type, text){
      formAlert.textContent = text;
      formAlert.className = 'mb-4 rounded-md border px-4 py-3 text-sm ' +
        (type === 'error' ? 'border-red-200 bg-red-50 text-red-800' : 'border-green-200 bg-green-50 text-green-800');
      formAlert.classList.remove('hidden');
      setTimeout(()=>formAlert.classList.add('hidden'), 2500);
    }

    // Image preview + client validation
    imgInput.addEventListener('change', (e)=>{
      const f = e.target.files?.[0];
      if(!f){ preview.src='https://via.placeholder.com/300x200?text=Preview'; return; }
      const okTypes = ['image/jpeg','image/png','image/webp'];
      if(!okTypes.includes(f.type)){ setFormAlert('error','Invalid image type. Please use JPG, PNG, or WEBP.'); imgInput.value=''; return; }
      if(f.size > 4*1024*1024){ setFormAlert('error','Image too large. Max 4MB.'); imgInput.value=''; return; }
      const reader = new FileReader();
      reader.onload = ev => preview.src = ev.target.result;
      reader.readAsDataURL(f);
    });

    // AJAX add product (uses add_inventory.php JSON path)
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      submitBtn.disabled = true;

      try{
        const fd = new FormData(form);
        const res = await fetch('add_inventory.php', { method:'POST', body: fd, headers: { 'Accept':'application/json' }});
        const json = await res.json().catch(()=>null);

        if(json && json.success){
          setFormAlert('success','Product added successfully.');
          form.reset();
          preview.src = 'https://via.placeholder.com/300x200?text=Preview';
          // refresh list from first page so the newest item appears
          offset = 0;
          await loadInventory();
        }else{
          setFormAlert('error', (json && (json.message||json.error)) || 'Failed to add product.');
        }
      }catch(err){
        console.error(err);
        setFormAlert('error','An unexpected error occurred.');
      }finally{
        submitBtn.disabled = false;
      }
    });

    function normalizePayload(payload){
      if(Array.isArray(payload)) return payload;
      if(payload && typeof payload === 'object'){
        if(Array.isArray(payload.data)) return payload.data;
      }
      return [];
    }

    function mapProduct(p){
      return {
        id: p.id ?? p.product_id ?? null,
        name: p.product_name ?? p.name ?? 'Unnamed',
        price: Number(p.price ?? 0),
        stock: Number(p.stock ?? p.quantity ?? 0),
        image: p.image_path || '',
      };
    }

    function renderRows(list){
      tableBody.innerHTML = '';
      if(!list.length){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="5" class="px-6 py-6 text-center text-sm text-gray-500">No products found.</td>`;
        tableBody.appendChild(tr);
        return;
      }

      const frag = document.createDocumentFragment();
      list.forEach(p=>{
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        const stockClass = p.stock <= LOW_STOCK ? 'text-red-600 font-semibold' : 'text-gray-700';
        const imgSrc = p.image || 'https://via.placeholder.com/64?text=No+Image';
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.name}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm ${stockClass}">${p.stock}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${fmtBDT(p.price)}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <img src="${imgSrc}" alt="Product Image" class="h-10 w-10 rounded-md object-cover border">
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <button class="text-red-600 hover:text-red-700 inline-flex items-center removeBtn" data-id="${p.id}">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
              </svg>
              Remove
            </button>
          </td>
        `;
        frag.appendChild(tr);
      });
      tableBody.appendChild(frag);

      // bind removes
      tableBody.querySelectorAll('.removeBtn').forEach(btn=>{
        btn.addEventListener('click', ()=> removeProduct(Number(btn.dataset.id)));
      });
    }

    function updatePagingControls(){
      const start = lastTotal === 0 ? 0 : (offset + 1);
      const end = offset + lastReturned;
      pagingInfo.textContent = lastTotal
        ? `Showing ${start}-${end} of ${lastTotal}`
        : 'No results';
      prevBtn.disabled = offset === 0;
      nextBtn.disabled = (offset + lastReturned) >= lastTotal;
    }

    async function loadInventory(){
      const params = new URLSearchParams();
      params.set('limit', String(limit));
      params.set('offset', String(offset));
      params.set('is_active', '1');
      const q = (search.value || '').trim();
      if(q) params.set('q', q);
      if(instockOnly.checked) params.set('in_stock_only', '1');

      try{
        const res = await fetch('fetch_inventory.php?' + params.toString(), { headers:{'Accept':'application/json'} });
        const json = await res.json();
        const products = normalizePayload(json).map(mapProduct);

        lastTotal = json?.paging?.total ?? products.length;
        lastReturned = products.length;

        renderRows(products);
        updatePagingControls();
      }catch(err){
        console.error(err);
        renderRows([]);
        lastTotal = 0; lastReturned = 0;
        updatePagingControls();
      }
    }

    async function removeProduct(productId){
      if(!productId) return;
      if(!confirm('Are you sure you want to remove this product?')) return;

      try{
        const res = await fetch('remove_product.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept':'application/json' },
          body: JSON.stringify({ id: productId })
        });
        const json = await res.json();
        if(json?.success){
          showToast('Product removed.');
          // if this was the only item on the page and not the first page, go back one page
          if(lastReturned === 1 && offset > 0){ offset = Math.max(0, offset - limit); }
          await loadInventory();
        }else{
          showToast(json?.error || 'Error removing product.');
        }
      }catch(err){
        console.error(err);
        showToast('Error removing product.');
      }
    }

    // Events
    search.addEventListener('input', () => { offset = 0; loadInventory(); });
    instockOnly.addEventListener('change', () => { offset = 0; loadInventory(); });
    prevBtn.addEventListener('click', () => { offset = Math.max(0, offset - limit); loadInventory(); });
    nextBtn.addEventListener('click', () => { offset = offset + limit; loadInventory(); });

    // Init
    loadInventory();
  </script>

</body>
</html>
